<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        /* === Ø§Ù„ØªØµÙ…ÙŠÙ… (Ø£Ø³ÙˆØ¯ x Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ) === */
        :root {
            --bg-main: #0a0a0a;
            --card-bg: #111;
            --border-color: #333;
            --orange-primary: #ff6600;
            --text-color: #ddd;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stat-card {
            background-color: #1a1e24;
            border: 1px solid var(--border-color);
            padding: 20px;
            text-align: center;
            border-bottom: 4px solid;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        /* ÙƒØ±Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .ticket-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: 0.3s;
        }
        .ticket-card:hover { transform: translateY(-5px); border-color: var(--orange-primary); }

        .ticket-header {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px dashed #333;
            font-size: 0.8rem;
            color: #777;
        }

        .ticket-body { padding: 15px; }

        .ticket-title {
            color: var(--orange-primary);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .ticket-msg {
            background-color: #000;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #222;
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 15px;
        }

        .student-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }
        .student-code { 
            background: #222; color: #fff; padding: 2px 8px; 
            border-radius: 4px; font-family: monospace; 
        }

        .btn-reply {
            width: 100%;
            background-color: var(--orange-primary);
            color: #000;
            font-weight: bold;
            border: none;
            padding: 10px;
            cursor: pointer;
        }
        .btn-reply:hover { background-color: #e65c00; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="row">
        <div class="col-md-6">
            <div class="stat-card" style="border-bottom-color: #00cc66;">
                <h2 class="fw-bold text-white" id="total-count">0</h2>
                <span class="text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stat-card" style="border-bottom-color: #ff3333;">
                <h2 class="fw-bold text-white">Live</h2>
                <span class="text-muted">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</span>
            </div>
        </div>
    </div>

    <h4 class="mb-4 text-white border-bottom pb-2 border-secondary">
        <span style="color: var(--orange-primary)">ğŸ“¥</span> ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯
    </h4>

    <div class="row" id="tickets-container">
        <div class="col-12 text-center text-muted py-5">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
        </div>
    </div>

</div>

<script type="module">
    // 1. Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ² Ù…Ù† Ø§Ù„ÙˆÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø©
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ (Ø²ÙŠ Ù…Ø§ Ø¨Ø¹ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¸Ø¨Ø·)
    const firebaseConfig = {
      apiKey: "AIzaSyDH3cy-jkDphnPGzHUwd4rd9ogZDY7uUgM",
      authDomain: "quest-full.firebaseapp.com",
      databaseURL: "https://quest-full-default-rtdb.firebaseio.com",
      projectId: "quest-full",
      storageBucket: "quest-full.firebasestorage.app",
      messagingSenderId: "501161882802",
      appId: "1:501161882802:web:08d6230eb09741a5c8c5ab"
    };

    // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 4. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªØ¬ÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ±Ø³Ù…Ù‡Ø§
    const ticketsContainer = document.getElementById('tickets-container');
    const totalCountEl = document.getElementById('total-count');

    // Ø¨Ù†Ù‚ÙˆÙ„Ù‡ Ù‡Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ÙƒÙˆÙ„ÙŠÙƒØ´Ù† "tickets" ÙˆØ±ØªØ¨Ù‡Ù… Ø¨Ø§Ù„Ø£Ø­Ø¯Ø«
    const q = query(collection(db, "tickets"), orderBy("createdAt", "desc"));

    // Ø§Ø³ØªÙ…Ø§Ø¹ Ø­ÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Real-time Listener)
    onSnapshot(q, (snapshot) => {
        ticketsContainer.innerHTML = ''; // Ø¨Ù†ÙØ¶ÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø£ÙˆÙ„
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        totalCountEl.innerText = snapshot.size;

        if (snapshot.empty) {
            ticketsContainer.innerHTML = '<div class="col-12 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
            return;
        }

        // Ù„Ù Ø¹Ù„Ù‰ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø³Ù…Ù‡Ø§
        snapshot.forEach((doc) => {
            const ticket = doc.data();
            const ticketId = doc.id;
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
            let dateString = "Ø§Ù„Ø¢Ù†";
            if (ticket.createdAt) {
                const date = new Date(ticket.createdAt.seconds * 1000);
                dateString = date.toLocaleString('ar-EG');
            }

            // ÙƒÙˆØ¯ Ø§Ù„Ù€ HTML Ù„ÙƒÙ„ ÙƒØ§Ø±Øª
            const html = `
                <div class="col-md-4 col-sm-6">
                    <div class="ticket-card">
                        <div class="ticket-header">
                            <span>${dateString}</span>
                            <span>#${ticketId.slice(0, 5)}</span>
                        </div>
                        <div class="ticket-body">
                            <div class="ticket-title">| ${ticket.subject || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
                            <div class="ticket-msg">${ticket.message || ''}</div>
                            
                            <div class="student-info">
                                <span style="color: #ff6600; font-weight: bold;">
                                    <i class="fas fa-user"></i> ${ticket.studentName || 'Ø·Ø§Ù„Ø¨'}
                                </span>
                                <span class="student-code">&lt;/&gt; ${ticket.studentCode || '---'}</span>
                            </div>
                        </div>
                        <button class="btn-reply" onclick="alert('Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨: ${ticket.studentName}')">Ø±Ø¯ Ø§Ù„Ø¢Ù†</button>
                    </div>
                </div>
            `;

            ticketsContainer.innerHTML += html;
        });
    }, (error) => {
        console.error("Error getting tickets: ", error);
        ticketsContainer.innerHTML = `<div class="col-12 text-center text-danger">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}<br>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Collection Ø¨Ø§Ø³Ù… tickets ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ²</div>`;
    });

</script>

</body>
</html>
