<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© | Full Mark</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-main: #0f172a;      /* ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ Ù„Ù„Ø®Ù„ÙÙŠØ© */
            --card-bg: #1e293b;      /* ÙƒØ­Ù„ÙŠ Ø£ÙØªØ­ Ù„Ù„ÙƒØ±ÙˆØª */
            --text-white: #ffffff;
            --text-gray: #cbd5e1;
            --gold: #f59e0b;         /* Ø°Ù‡Ø¨ÙŠ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ù‡Ù…Ø© */
            --blue-btn: #3b82f6;     /* Ø£Ø²Ø±Ø§Ø± Ø²Ø±Ù‚Ø§Ø¡ Ø²Ø§Ù‡ÙŠØ© */
            --danger: #ef4444;
            --success: #10b981;
        }

        body {
            background-color: var(--bg-main);
            font-family: 'Cairo', sans-serif;
            color: var(--text-white);
            padding-bottom: 50px;
        }

        /* === Ø§Ù„Ù‡ÙŠØ¯Ø± === */
        .royal-nav {
            background: #1e293b;
            border-bottom: 2px solid var(--gold);
            padding: 15px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .brand-title {
            font-weight: 900;
            font-size: 1.4rem;
            color: var(--text-white);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .brand-title i { color: var(--gold); margin-left: 10px; }

        /* === Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª === */
        .stats-row {
            display: flex;
            gap: 15px;
            padding: 20px;
            overflow-x: auto;
        }
        .stat-box {
            background: var(--card-bg);
            min-width: 120px;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #334155;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .stat-num {
            font-size: 2rem;
            font-weight: 900;
            display: block;
            line-height: 1.1;
        }
        .stat-title { font-size: 0.9rem; color: var(--text-gray); font-weight: 700; }

        /* === ÙƒØ±ÙˆØª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ === */
        .tickets-container { padding: 10px 20px; }

        .ticket-card {
            background: var(--card-bg);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid #334155;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }
        .ticket-card:active { transform: scale(0.98); }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù„ÙˆÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .status-bar { height: 6px; width: 100%; }
        .bar-new { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .bar-late { background: var(--danger); box-shadow: 0 0 10px var(--danger); }
        .bar-done { background: var(--success); }

        .card-content { padding: 20px; }

        /* Ø±Ø£Ø³ Ø§Ù„ÙƒØ§Ø±Øª */
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .student-name {
            font-size: 1.2rem;
            font-weight: 900;
            color: var(--text-white);
        }
        .student-code {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 8px;
            font-family: monospace;
            color: var(--gold);
            font-size: 1rem;
            font-weight: bold;
        }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
        .msg-preview {
            background: #0f172a; /* Ù„ÙˆÙ† Ø£ØºÙ…Ù‚ Ù„Ù„ØªØ¨Ø§ÙŠÙ† */
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #334155;
            color: #e2e8f0;
            font-size: 1.1rem; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· */
            font-weight: 600;  /* ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø®Ø· */
            line-height: 1.6;
            margin-bottom: 20px;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .actions-row {
            display: flex;
            gap: 10px;
        }
        
        .btn-view {
            background: transparent;
            border: 2px solid var(--text-gray);
            color: var(--text-gray);
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
        }
        
        .btn-reply {
            background: var(--blue-btn);
            border: none;
            color: white;
            flex: 2; /* Ø§Ù„Ø²Ø±Ø§Ø± Ø¯Ù‡ Ø£Ø¹Ø±Ø¶ */
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }

        /* Ø£Ø±Ø´ÙŠÙ */
        .archive-title {
            color: var(--text-gray);
            font-weight: 700;
            margin: 30px 20px 15px;
            border-bottom: 1px solid #334155;
            padding-bottom: 10px;
        }
        .archived-item {
            opacity: 0.6;
            filter: grayscale(0.5);
        }

        /* Modal */
        .modal-content {
            background: var(--card-bg);
            color: white;
            border: 1px solid var(--gold);
            border-radius: 20px;
        }
        .modal-header, .modal-footer { border-color: #334155; }
        .form-control {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .form-control:focus {
            background: #0f172a;
            color: white;
            border-color: var(--blue-btn);
            box-shadow: none;
        }
    </style>
</head>
<body>

    <nav class="royal-nav">
        <div class="brand-title"><i class="fas fa-crown"></i> Full Mark</div>
        <div style="font-size:0.9rem; font-weight:bold; color:var(--text-gray)">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    </nav>

    <div class="stats-row">
        <div class="stat-box">
            <span class="stat-num" style="color: var(--gold)" id="pending-count">0</span>
            <span class="stat-title">ÙˆØ§Ø±Ø¯</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" style="color: var(--danger)" id="overdue-count">0</span>
            <span class="stat-title">Ù…ØªØ£Ø®Ø±</span>
        </div>
        <div class="stat-box">
            <span class="stat-num" style="color: var(--success)" id="replied-count">0</span>
            <span class="stat-title">Ù…Ù†Ø¬Ø²</span>
        </div>
    </div>

    <div class="tickets-container" id="active-tickets">
        <div class="text-center py-5 text-muted fw-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <div class="archive-title"><i class="fas fa-check-double me-2"></i> ØªÙ… Ø§Ù„Ø±Ø¯ (Ø§Ù„ÙŠÙˆÙ…)</div>
    <div class="tickets-container" id="archive-tickets"></div>

    <div class="modal fade" id="replyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="modal-student-name">Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø§Ù„Ø¨</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="p-3 mb-3 rounded" style="background: rgba(255,255,255,0.05); border: 1px dashed #555;">
                        <small class="text-muted d-block mb-1">Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:</small>
                        <p id="full-message-view" class="m-0 fw-bold"></p>
                    </div>

                    <textarea id="reply-text" class="form-control" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ù‡Ù†Ø§..."></textarea>
                    
                    <div class="mt-3 d-flex gap-2 justify-content-center">
                        <button class="btn btn-sm btn-outline-light fw-bold" onclick="fillReply('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ…')">ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„</button>
                        <button class="btn btn-sm btn-outline-light fw-bold" onclick="fillReply('ÙƒÙˆØ¯ Ø®Ø·Ø£ âŒ')">ÙƒÙˆØ¯ Ø®Ø·Ø£</button>
                        <button class="btn btn-sm btn-outline-light fw-bold" onclick="fillReply('ØªÙ… Ø§Ù„Ø­Ù„ ğŸ”„')">ØªÙ… Ø§Ù„Ø­Ù„</button>
                    </div>

                    <input type="hidden" id="current-ticket-id">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary w-100 fw-bold py-2 fs-5" onclick="submitReply()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ ğŸš€</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDH3cy-jkDphnPGzHUwd4rd9ogZDY7uUgM",
            authDomain: "quest-full.firebaseapp.com",
            databaseURL: "https://quest-full-default-rtdb.firebaseio.com", 
            projectId: "quest-full",
            storageBucket: "quest-full.firebasestorage.app",
            messagingSenderId: "501161882802",
            appId: "1:501161882802:web:08d6230eb09741a5c8c5ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const activeDiv = document.getElementById('active-tickets');
        const archiveDiv = document.getElementById('archive-tickets');
        
        // Modal Setup
        const replyModal = new bootstrap.Modal(document.getElementById('replyModal'));
        const replyInput = document.getElementById('reply-text');
        const ticketIdInput = document.getElementById('current-ticket-id');
        const fullMsgView = document.getElementById('full-message-view');
        const modalTitle = document.getElementById('modal-student-name');

        window.openReply = (id, name, message) => {
            ticketIdInput.value = id;
            modalTitle.innerText = name;
            fullMsgView.innerText = message; // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬ÙˆÙ‡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙƒÙ…Ø§Ù†
            replyInput.value = '';
            replyModal.show();
        };

        // Ø²Ø±Ø§Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· (Ø¨ÙŠÙØªØ­ Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø³ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø±Ø¯)
        window.viewMessage = (id, name, message) => {
             openReply(id, name, message);
        };

        window.fillReply = (txt) => { replyInput.value = txt; };

        window.submitReply = () => {
            const id = ticketIdInput.value;
            const reply = replyInput.value;
            if(!reply) return alert("Ø§ÙƒØªØ¨ Ø±Ø¯!");

            update(ref(db, `support_tickets/${id}`), {
                status: 'replied',
                adminReply: reply,
                repliedAt: Date.now()
            }).then(() => replyModal.hide());
        };

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        onValue(ref(db, 'support_tickets'), (snapshot) => {
            const data = snapshot.val();
            activeDiv.innerHTML = '';
            archiveDiv.innerHTML = '';

            if (!data) {
                activeDiv.innerHTML = `<div class="text-center py-5"><i class="fas fa-check-circle fa-4x text-success mb-3"></i><h3 class="fw-bold">ÙƒÙ„Ù‡ ØªÙ…Ø§Ù…!</h3></div>`;
                return;
            }

            let tickets = Object.keys(data).map(k => ({id: k, ...data[k]}));
            
            // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø­Ø¯Ø« ÙÙˆÙ‚
            tickets.sort((a, b) => {
                let tA = a.createdAt?.seconds ? a.createdAt.seconds * 1000 : (a.createdAt || 0);
                let tB = b.createdAt?.seconds ? b.createdAt.seconds * 1000 : (b.createdAt || 0);
                return tB - tA;
            });

            let pending = 0, overdue = 0, replied = 0;
            const now = Date.now();

            tickets.forEach(t => {
                let created = t.createdAt?.seconds ? t.createdAt.seconds * 1000 : (t.createdAt || 0);
                let diff = (now - created) / 36e5; // hours

                if (t.status === 'replied') {
                    // Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ù„Ù…Ø¯Ø© 24 Ø³Ø§Ø¹Ø© ÙÙ‚Ø·)
                    if ((now - (t.repliedAt || 0)) < 86400000) {
                        replied++;
                        archiveDiv.innerHTML += `
                            <div class="ticket-card archived-item">
                                <div class="status-bar bar-done"></div>
                                <div class="card-content">
                                    <div class="student-header mb-1">
                                        <span class="student-name" style="font-size:1rem">${t.studentName}</span>
                                        <span class="badge bg-success">ØªÙ… Ø§Ù„Ø±Ø¯</span>
                                    </div>
                                    <p class="text-muted small m-0 text-truncate">${t.message}</p>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    pending++;
                    let barClass = 'bar-new';
                    let statusLabel = 'Ø¬Ø¯ÙŠØ¯';
                    
                    if (diff > 24) {
                        overdue++;
                        barClass = 'bar-late';
                        statusLabel = 'Ù…ØªØ£Ø®Ø±';
                    }

                    // Ù‡Ù†Ø§ Ø¨Ù†Ø¹Ù…Ù„ Encode Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø´Ø§Ù† ØªØªØ¨Ø¹Øª Ù„Ù„Ø¯Ø§Ù„Ø© ØµØ­ Ù„Ùˆ ÙÙŠÙ‡Ø§ Ø¹Ù„Ø§Ù…Ø§Øª ØºØ±ÙŠØ¨Ø©
                    let safeMsg = t.message.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    activeDiv.innerHTML += `
                        <div class="ticket-card">
                            <div class="status-bar ${barClass}"></div>
                            <div class="card-content">
                                <div class="student-header">
                                    <div>
                                        <div class="student-name">${t.studentName}</div>
                                        <span class="badge ${diff > 24 ? 'bg-danger' : 'bg-warning text-dark'}">${statusLabel}</span>
                                    </div>
                                    <span class="student-code">${t.studentCode || 'N/A'}</span>
                                </div>
                                
                                <div class="msg-preview">
                                    ${t.message}
                                </div>

                                <div class="actions-row">
                                    <button class="btn-view" onclick="viewMessage('${t.id}', '${t.studentName}', '${safeMsg}')">
                                        <i class="far fa-eye"></i> Ø¹Ø±Ø¶
                                    </button>
                                    <button class="btn-reply" onclick="openReply('${t.id}', '${t.studentName}', '${safeMsg}')">
                                        <i class="fas fa-reply"></i> Ø±Ø¯ Ø§Ù„Ø¢Ù†
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            document.getElementById('pending-count').innerText = pending;
            document.getElementById('overdue-count').innerText = overdue;
            document.getElementById('replied-count').innerText = replied;
        });
    </script>
</body>
</html>
